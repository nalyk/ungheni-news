<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap CMS - Triunghi.md</title>
  </head>
  <body>
    <!-- Debug postMessage reception -->
    <script>
      console.log('üîß CMS: Setting up postMessage listener for debugging...');
      window.addEventListener('message', function(event) {
        console.log('üéØ CMS: Received postMessage from:', event.origin);
        console.log('üîç CMS: Message data:', event.data);
        console.log('üîç CMS: Message type:', typeof event.data);
        
        // Check if this looks like our auth message
        if (typeof event.data === 'string' && event.data.includes('authorization:github:')) {
          console.log('‚úÖ CMS: This looks like our auth message!');
          if (event.data.includes('success')) {
            console.log('üéâ CMS: SUCCESS message detected');
          } else if (event.data.includes('error')) {
            console.log('‚ùå CMS: ERROR message detected');
          }
        } else {
          console.log('üìù CMS: Not our auth message, probably CMS internal');
        }
      }, false);
    </script>
    
    <!-- Latest Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>

    <!-- Custom Preview Styles -->
    <link rel="stylesheet" href="/admin/preview.css">

    <!-- Custom Preview Template -->
    <script src="/admin/preview.js"></script>

    <!-- Triunghi.md Validation Logic -->
    <script>
      // Custom validation for Triunghi.md editorial requirements
      CMS.registerEventListener({
        name: 'prePublish',
        handler: ({ entry, author, collection }) => {
          const data = entry.get('data').toJS();
          
          // Validate Cutia Ungheni for National/UE articles
          const categories = Array.isArray(data.categories) ? data.categories : [data.categories || ''];
          const formats = Array.isArray(data.formats) ? data.formats : [data.formats || ''];
          
          if (categories.some(cat => ['national', 'ue-romania'].includes(cat))) {
            // Check if cutia_ungheni is filled out with at least one field
            if (!data.cutia_ungheni || 
                (typeof data.cutia_ungheni === 'object' && 
                 Object.values(data.cutia_ungheni).every(val => !val))) {
              const errorMessage = '‚ùå Articolul din categoriile Na»õional/UE Rom√¢nia trebuie sƒÉ aibƒÉ completatƒÉ "Cutia Ungheni" cu: impact local, ce se schimbƒÉ pentru locuitori, termene importante »ôi unde se aplicƒÉ.';
              alert(errorMessage);
              throw new Error('Cutia Ungheni lipse»ôte pentru articol na»õional/UE');
            }
          }
          
          // Validate fact-check requirements
          if (formats.includes('factcheck')) {
            if (!data.verification?.sources || data.verification.sources.length === 0) {
              const errorMessage = '‚ùå Articolul de tip fact-check trebuie sƒÉ aibƒÉ surse documentate √Æn sec»õiunea de verificare.';
              alert(errorMessage);
              throw new Error('Sursele lipsesc pentru fact-check');
            }
            if (!data.fact_check_rating) {
              const errorMessage = '‚ùå Articolul de tip fact-check trebuie sƒÉ aibƒÉ un rating (AdevƒÉrat/Fals/etc.).';
              alert(errorMessage);
              throw new Error('Ratingul lipse»ôte pentru fact-check');
            }
          }
          
          // Validate opinion disclaimer
          if (formats.includes('opinie')) {
            if (!data.authors || data.authors.length === 0) {
              const errorMessage = '‚ùå Articolul de opinie trebuie sƒÉ aibƒÉ un autor definit.';
              alert(errorMessage);
              throw new Error('Autorul lipse»ôte pentru articol de opinie');
            }
          }
        }
      });

      // Real-time form validation
      let validationTimeout;
      CMS.registerEventListener({
        name: 'change',
        handler: ({ entry, collection }) => {
          // Debounce validation to avoid excessive processing
          clearTimeout(validationTimeout);
          validationTimeout = setTimeout(() => {
            performRealTimeValidation(entry);
          }, 500);
        }
      });
      
      // Track validation state to control publish button
      let validationPassed = true;
      
      function performRealTimeValidation(entry) {
        const data = entry.get('data').toJS();
        
        // Clear previous error indicators
        document.querySelectorAll('.triunghi-validation-error').forEach(el => el.remove());
        
        const categories = Array.isArray(data.categories) ? data.categories : [data.categories || ''];
        const formats = Array.isArray(data.formats) ? data.formats : [data.formats || ''];
        
        // Check validation requirements
        let hasValidationError = false;
        
        // Real-time validation
        if (categories.some(cat => ['national', 'ue-romania'].includes(cat))) {
          if (!data.cutia_ungheni || 
              (typeof data.cutia_ungheni === 'object' && 
               Object.values(data.cutia_ungheni).every(val => !val))) {
            showValidationError('‚ö†Ô∏è Articolul din categoriile Na»õional/UE Rom√¢nia trebuie sƒÉ aibƒÉ completatƒÉ "Cutia Ungheni"');
            hasValidationError = true;
          }
        }
        
        if (formats.includes('factcheck')) {
          if (!data.verification?.sources || data.verification.sources.length === 0) {
            showValidationError('‚ö†Ô∏è Fact-check: Sursele documentate sunt obligatorii');
            hasValidationError = true;
          }
          if (!data.fact_check_rating) {
            showValidationError('‚ö†Ô∏è Fact-check: Ratingul este obligatoriu (AdevƒÉrat/Fals/etc.)');
            hasValidationError = true;
          }
        }
        
        if (formats.includes('opinie')) {
          if (!data.authors || data.authors.length === 0) {
            showValidationError('‚ö†Ô∏è Opinie: Autorul este obligatoriu');
            hasValidationError = true;
          }
        }
        
        // Update validation state
        validationPassed = !hasValidationError;
        
        // Control publish button
        updatePublishButtonState();
      }
      
      function updatePublishButtonState() {
        // Try to find the publish button and enable/disable based on validation
        setTimeout(() => {
          const publishButton = findPublishButton();
          if (publishButton) {
            if (!validationPassed) {
              publishButton.disabled = true;
              publishButton.title = '‚ö†Ô∏è CompleteazƒÉ c√¢mpurile obligatorii conform filozofiei Triunghi.md';
              publishButton.style.opacity = '0.6';
              publishButton.style.cursor = 'not-allowed';
            } else {
              publishButton.disabled = false;
              publishButton.title = '';
              publishButton.style.opacity = '1';
              publishButton.style.cursor = 'pointer';
            }
          }
        }, 100); // Small delay to ensure DOM is updated
      }
      
      function findPublishButton() {
        // Look for the publish button in various possible selectors
        return document.querySelector('button[data-testid="publish-button"]') ||
               document.querySelector('button.nc-btn--primary') ||
               document.querySelector('button[class*="publish" i]') ||
               document.querySelector('button[type="submit"]') ||
               Array.from(document.querySelectorAll('button')).find(btn => 
                 btn.textContent.toLowerCase().includes('publish') || 
                 btn.textContent.toLowerCase().includes('publicƒÉ') ||
                 btn.textContent.toLowerCase().includes('save') ||
                 btn.textContent.toLowerCase().includes('salveazƒÉ')
               );
      }
      
      function showValidationError(message) {
        // Create error indicator
        const errorDiv = document.createElement('div');
        errorDiv.className = 'triunghi-validation-error';
        errorDiv.style.cssText = `
          background: #fff3cd;
          border: 2px solid #ffc107;
          color: #856404;
          padding: 12px 15px;
          margin: 10px 0;
          border-radius: 4px;
          font-weight: 500;
          position: relative;
          z-index: 9999;
        `;
        errorDiv.textContent = message;
        
        // Insert near the form
        const formContainer = document.querySelector('.nc-root .nc-entity-title')?.parentElement || 
                             document.querySelector('.nc-root .nc-entity-form-container') || 
                             document.querySelector('.nc-root') || 
                             document.body;
        if (formContainer) {
          const firstChild = formContainer.firstChild || formContainer.firstElementChild;
          if (firstChild) {
            formContainer.insertBefore(errorDiv, firstChild);
          } else {
            formContainer.appendChild(errorDiv);
          }
        }
      }
    </script>
  </body>
</html>