<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap CMS - Triunghi.md</title>
  </head>
  <body>
    <!-- Debug OAuth messages -->
    <script>
      console.log('🎯 CMS: Setting up OAuth message listener...');
      
      // Listen for OAuth messages from popup
      window.addEventListener('message', function(event) {
        console.log('🎯 CMS: Received message from', event.origin, ':', event.data);
        
        // Log all message properties for debugging
        console.log('🔍 Message details:', {
          origin: event.origin,
          source: event.source,
          data: event.data,
          type: typeof event.data,
          keys: Object.keys(event.data || {})
        });
        
        // Check if this looks like an OAuth response
        if (event.data && (event.data.type === 'authorization-code' || event.data.token || event.data.access_token)) {
          console.log('✅ CMS: Detected OAuth message!', event.data);
          
          // Store token in localStorage as fallback
          if (event.data.token) {
            localStorage.setItem('triunghi-auth-token', event.data.token);
            console.log('💾 CMS: Stored token in localStorage');
          }
          if (event.data.access_token) {
            localStorage.setItem('triunghi-auth-token', event.data.access_token);
            console.log('💾 CMS: Stored access_token in localStorage');
          }
        }
      }, false);
      
      // Also listen for storage changes (in case localStorage method works)
      window.addEventListener('storage', function(event) {
        console.log('📦 CMS: Storage event:', event.key, event.newValue);
        if (event.key === 'triunghi-auth-token') {
          console.log('✅ CMS: Auth token detected in storage!');
        }
      });
      
      console.log('✨ CMS: OAuth debugging setup complete');
    </script>
    
    <!-- Latest Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    
    <!-- Force CMS authentication after OAuth -->
    <script>
      console.log('🔧 CMS: Setting up authentication interceptor...');
      
      // Wait for CMS to be ready, then intercept authentication
      const waitForCMS = () => {
        if (window.CMS) {
          console.log('✅ CMS: Decap CMS loaded, setting up auth interceptor');
          setupAuthInterceptor();
        } else {
          console.log('⏳ CMS: Waiting for Decap CMS to load...');
          setTimeout(waitForCMS, 500);
        }
      };
      
      function setupAuthInterceptor() {
        // Check for stored auth token and force login
        const checkStoredAuth = () => {
          const token = localStorage.getItem('triunghi-auth-token');
          if (token && token.startsWith('gho_')) {
            console.log('🔑 CMS: Found stored auth token, forcing login state');
            
            // Try to trigger CMS login state
            try {
              // Method 1: Trigger a custom event that CMS might listen to
              window.dispatchEvent(new CustomEvent('cms-auth-complete', {
                detail: { token: token, provider: 'github' }
              }));
              
              // Method 2: Try to access CMS internals if available
              if (window.CMS && window.CMS.getBackend) {
                console.log('🔧 CMS: Attempting to set backend auth state');
                const backend = window.CMS.getBackend();
                if (backend && backend.authenticate) {
                  backend.authenticate({ token: token });
                }
              }
              
              // Method 3: Dispatch auth success event
              window.postMessage({
                type: 'cms-auth-success',
                token: token,
                provider: 'github'
              }, window.location.origin);
              
              // Method 4: Force page refresh to reload with auth state
              setTimeout(() => {
                console.log('🔄 CMS: Force refreshing to update auth state');
                window.location.reload();
              }, 3000);
              
            } catch (error) {
              console.error('❌ CMS: Error setting auth state:', error);
            }
          }
        };
        
        // Check immediately and after any auth messages
        checkStoredAuth();
        
        // Also check when we receive new auth messages
        window.addEventListener('message', function(event) {
          if (event.data && (event.data.token || event.data.access_token)) {
            setTimeout(checkStoredAuth, 100);
          }
        });
      }
      
      // Start waiting for CMS
      waitForCMS();
      
      // Also try immediate check in case CMS loads quickly
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(waitForCMS, 1000);
      });
    </script>
  </body>
</html>

