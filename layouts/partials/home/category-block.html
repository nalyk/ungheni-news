{{ $category_slug := .category }}
{{ $limit := .limit | default 4 }}
{{/* WORKAROUND: Extract language from URL since .Site.Language.Lang returns default lang */}}
{{ $url_parts := split .context.RelPermalink "/" }}
{{ $lang := index $url_parts 1 }}
{{ if not $lang }}{{ $lang = .context.Site.Language.Lang }}{{ end }}
{{/* WORKAROUND: .Site.GetPage doesn't work for non-default language sections, use AllPages filter */}}
{{ $lang_news_path := printf "/%s/news/" $lang }}
{{ $sec := index (where .context.Site.AllPages "RelPermalink" $lang_news_path) 0 }}
{{ $all := cond (ne $sec nil) ($sec.RegularPages | default $sec.Pages) (slice) }}

{{/* Build a robust page list where categories may be string or list */}}
{{ $.Scratch.Set "_cat_pages" (slice) }}
{{ range $p := $all }}
  {{ $rc := $p.Params.categories }}
  {{ $pc := cond (reflect.IsSlice $rc) $rc (slice $rc) }}
  {{ if in ($pc | default (slice)) $category_slug }}
    {{ $.Scratch.Add "_cat_pages" (slice $p) }}
  {{ end }}
{{ end }}
{{ $_cp := $.Scratch.Get "_cat_pages" | default (slice) }}
{{ $pages := first $limit $_cp }}

{{ if $pages }}
<section class="category-block">
  <h2 class="category-title"><a href="#">{{ i18n $category_slug | default $category_slug }}</a></h2>
  <div class="category-grid-{{ $limit }}">
    {{ range $i, $p := $pages }}
      {{ $card_class := "card-standard" }}
      {{ if eq $i 0 }}{{ $card_class = "card-featured" }}{{ end }}
      {{ partial "home/category-card.html" (dict "page" $p "card_class" $card_class) }}
    {{ end }}
  </div>
</section>
{{ end }}
