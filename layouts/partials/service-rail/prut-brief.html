{{/* Prut Brief Newsletter Signup Service Rail Component */}}
<section class="service-rail newsletter card">
  <h3>{{ i18n "prut_brief_title" | default "Prut Brief - Newsletter local" }}</h3>
  
  <div class="newsletter-content">
    <div class="newsletter-description">
      <p>{{ i18n "prut_brief_description" | default "Cele mai importante știri locale, zilnic la 18:00" }}</p>
    </div>
    
    {{/* Subscriber count removed - using real backend now */}}
    
    <form class="newsletter-form" action="#" method="post" id="newsletter-signup">
      <div class="form-group">
        <label for="newsletter-email" class="sr-only">{{ i18n "email_address" | default "Adresa de email" }}</label>
        <input 
          type="email" 
          id="newsletter-email" 
          name="email" 
          placeholder="{{ i18n "email_placeholder" | default "adresa@email.com" }}"
          required
          class="email-input"
          aria-describedby="email-error"
        />
        <div id="email-error" class="error-message" role="alert"></div>
      </div>
      
      <button type="submit" class="submit-button">
        {{ i18n "subscribe_free" | default "Abonează-te gratuit" }}
      </button>
      
      <div class="form-status" role="status" aria-live="polite"></div>
    </form>
    
    <div class="newsletter-preview">
      <a href="#" class="preview-link">
        {{ i18n "sample_newsletter" | default "Vezi un exemplu de newsletter" }}
        <span class="external-indicator">↗</span>
      </a>
    </div>
    
    <div class="privacy-note">
      <small>{{ i18n "privacy_note" | default "Nu spam, dezabonare oricând. Datele sunt protejate conform GDPR." }}</small>
    </div>
  </div>
</section>

<script>
(function() {
  const form = document.getElementById('newsletter-signup');
  const emailInput = document.getElementById('newsletter-email');
  const errorDiv = document.getElementById('email-error');
  const statusDiv = document.querySelector('.form-status');

  if (!form) return;

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Clear previous messages
    clearMessages();

    const email = emailInput.value.trim();

    // Client-side validation
    if (!validateEmail(email)) {
      showError('{{ i18n "invalid_email" | default "Vă rugăm să introduceți o adresă de email validă" }}');
      return;
    }

    // Show loading state
    showStatus('{{ i18n "subscribing" | default "Se înregistrează..." }}', 'loading');
    const submitButton = form.querySelector('.submit-button');
    submitButton.disabled = true;

    try {
      // Call Buttondown API via Cloudflare Function
      const response = await fetch('/api/newsletter', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      });

      const data = await response.json();

      if (data.success) {
        // Success - show confirmation message
        showStatus(
          data.message || '{{ i18n "subscription_success" | default "Mulțumim! Veți primi primul newsletter astăzi la 18:00." }}',
          'success'
        );
        emailInput.value = '';

        // Keep button disabled for 3 seconds to prevent double submission
        setTimeout(() => {
          submitButton.disabled = false;
        }, 3000);
      } else {
        // Error from API
        showError(data.error || '{{ i18n "subscription_error" | default "A apărut o eroare. Încercați din nou." }}');
        submitButton.disabled = false;
      }
    } catch (error) {
      // Network or other error
      console.error('Newsletter signup error:', error);
      showError('{{ i18n "network_error" | default "Eroare de conexiune. Verificați internetul și încercați din nou." }}');
      submitButton.disabled = false;
    }
  });

  emailInput.addEventListener('input', function() {
    clearMessages();
  });

  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    emailInput.setAttribute('aria-invalid', 'true');
  }

  function showStatus(message, type = 'info') {
    statusDiv.textContent = message;
    statusDiv.className = 'form-status ' + type;
    statusDiv.style.display = 'block';
  }

  function clearMessages() {
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
    statusDiv.style.display = 'none';
    statusDiv.textContent = '';
    emailInput.removeAttribute('aria-invalid');
  }
})();
</script>