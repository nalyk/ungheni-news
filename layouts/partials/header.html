<header class="site-header">
  <div class="container">
    <div class="header-content">
      {{/* WORKAROUND: Extract language from URL since .Site.Language.Lang returns default lang */}}
      {{ $url_parts := split .RelPermalink "/" }}
      {{ $lang := index $url_parts 1 }}
      {{ if not (or (eq $lang "ro") (eq $lang "ru")) }}{{ $lang = .Site.Language.Lang }}{{ end }}
      {{ $prefix := cond (eq $lang "ro") "" (printf "/%s" $lang) }}

      <div class="masthead">
        <a href="{{ $prefix }}/" class="masthead-link">
          <img src="{{ "img/logo.svg" | relURL }}" alt="{{ .Site.Title }} logo" class="masthead-logo" />
          <h1 class="site-title">{{ .Site.Title }}</h1>
        </a>
      </div>

      <nav class="primary-nav" aria-label="{{ i18n "main_navigation" }}">
        <ul>
          {{ $cats := site.Data.categories }}
          {{ range first 7 $cats }}
            {{ $title := cond (eq $lang "ru") (.ru | default .ro) .ro }}
            {{ $href := printf "%s/categories/%s/" $prefix .slug }}
            <li><a href="{{ $href }}" {{ if eq $.RelPermalink $href }}aria-current="page"{{ end }}>{{ $title }}</a></li>
          {{ end }}
        </ul>
      </nav>

      <div class="header-actions">
        <div class="lang-picker">
          {{/* UNIVERSAL LANGUAGE SWITCHER: 100% URL-based detection (no Hugo properties) */}}
          {{/* Uses URL path analysis to find translated content across all page types */}}

          {{/* Detect current and target language from URL */}}
          {{ $current_lang := $lang }}
          {{ $target_lang := cond (eq $current_lang "ro") "ru" "ro" }}
          {{ $target_url := "" }}

          {{/* Parse URL to determine page type and content */}}
          {{ $url_parts := split .RelPermalink "/" }}
          {{/* URL structure: ["", "ro", "news", "01-article-slug", ""] or ["", "news", "01-article-slug", ""] for RO */}}
          {{ $section := "" }}
          {{ $slug := "" }}

          {{/* Determine section based on URL position */}}
          {{ if eq (len $url_parts) 5 }}
            {{/* Has language prefix: /ro/news/slug/ or /ru/pages/slug/ */}}
            {{ $section = index $url_parts 2 }}
            {{ $slug = index $url_parts 3 }}
          {{ else if eq (len $url_parts) 4 }}
            {{/* RO without prefix: /news/slug/ or /pages/slug/ */}}
            {{ $section = index $url_parts 1 }}
            {{ $slug = index $url_parts 2 }}
          {{ else if eq (len $url_parts) 4 }}
            {{/* Taxonomy or category: /ro/categories/slug/ */}}
            {{ $section = index $url_parts 2 }}
            {{ $slug = index $url_parts 3 }}
          {{ end }}

          {{/* Route based on URL section */}}
          {{ if eq $section "news" }}
            {{/* NEWS ARTICLES: Match by numeric prefix (01-, 02-, etc.) */}}
            {{ $prefix_parts := split $slug "-" }}
            {{ $prefix := index $prefix_parts 0 }}

            {{/* Search target language news for matching prefix */}}
            {{ $target_news_path := printf "/%s/news/" $target_lang }}
            {{ $target_section := index (where .Site.AllPages "RelPermalink" $target_news_path) 0 }}
            {{ $target_pages := cond (ne $target_section nil) ($target_section.RegularPages | default $target_section.Pages) (slice) }}

            {{ $found := false }}
            {{ range $target_pages }}
              {{ $target_url_parts := split .RelPermalink "/" }}
              {{ $target_slug := "" }}
              {{ if eq (len $target_url_parts) 5 }}
                {{ $target_slug = index $target_url_parts 3 }}
              {{ else if eq (len $target_url_parts) 4 }}
                {{ $target_slug = index $target_url_parts 2 }}
              {{ end }}
              {{ if $target_slug }}
                {{ $target_prefix_parts := split $target_slug "-" }}
                {{ $target_prefix := index $target_prefix_parts 0 }}
                {{ if eq $target_prefix $prefix }}
                  {{ $target_url = .RelPermalink }}
                  {{ $found = true }}
                {{ end }}
              {{ end }}
            {{ end }}

            {{/* Fallback to homepage if no translation */}}
            {{ if not $found }}
              {{ $target_url = cond (eq $target_lang "ro") "/" (printf "/%s/" $target_lang) }}
            {{ end }}

          {{ else if eq $section "pages" }}
            {{/* STATIC PAGES: Direct slug match */}}
            {{ $target_prefix := cond (eq $target_lang "ro") "" (printf "/%s" $target_lang) }}
            {{ $target_url = printf "%s/pages/%s/" $target_prefix $slug }}

          {{ else if in (slice "categories" "formats" "authors" "tags" "series") $section }}
            {{/* TAXONOMIES: Same term in other language */}}
            {{ $target_prefix := cond (eq $target_lang "ro") "" (printf "/%s" $target_lang) }}
            {{ $target_url = printf "%s/%s/%s/" $target_prefix $section $slug }}

          {{ else }}
            {{/* HOMEPAGE or other: Target language homepage */}}
            {{ $target_url = cond (eq $target_lang "ro") "/" (printf "/%s/" $target_lang) }}
          {{ end }}

          <a href="{{ $target_url }}" class="lang-option">{{ $target_lang | upper }}</a>
        </div>
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Menu" aria-expanded="false">
          <span class="hamburger"></span>
        </button>
      </div>
    </div>
  </div>
  <div id="mobile-nav" class="mobile-nav">
    <nav>
      <ul>
        {{/* Reuse language detection from above (same workaround pattern) */}}
        {{ $url_parts := split .RelPermalink "/" }}
        {{ $lang := index $url_parts 1 }}
        {{ if not (or (eq $lang "ro") (eq $lang "ru")) }}{{ $lang = .Site.Language.Lang }}{{ end }}
        {{ $prefix := cond (eq $lang "ro") "" (printf "/%s" $lang) }}
        {{ $cats := site.Data.categories }}
        {{ range $cats }}
          {{ $title := cond (eq $lang "ru") (.ru | default .ro) .ro }}
          {{ $href := printf "%s/categories/%s/" $prefix .slug }}
          <li><a href="{{ $href }}">{{ $title }}</a></li>
        {{ end }}
      </ul>
    </nav>
  </div>
</header>
