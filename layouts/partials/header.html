<header class="site-header">
  <div class="container">
    <div class="header-content">
      {{/* WORKAROUND: Extract language from URL since .Site.Language.Lang returns default lang */}}
      {{ $url_parts := split .RelPermalink "/" }}
      {{ $lang := index $url_parts 1 }}
      {{ if not (or (eq $lang "ro") (eq $lang "ru")) }}{{ $lang = .Site.Language.Lang }}{{ end }}
      {{ $prefix := cond (eq $lang "ro") "" (printf "/%s" $lang) }}

      <div class="masthead">
        <a href="{{ $prefix }}/" class="masthead-link">
          <img src="{{ "img/logo.svg" | relURL }}" alt="{{ .Site.Title }} logo" class="masthead-logo" />
          <h1 class="site-title">{{ .Site.Title }}</h1>
        </a>
      </div>

      <nav class="primary-nav" aria-label="{{ i18n "main_navigation" }}">
        <ul>
          {{ $cats := site.Data.categories }}
          {{ range first 7 $cats }}
            {{ $title := cond (eq $lang "ru") (.ru | default .ro) .ro }}
            {{ $href := printf "%s/categories/%s/" $prefix .slug }}
            <li><a href="{{ $href }}" {{ if eq $.RelPermalink $href }}aria-current="page"{{ end }}>{{ $title }}</a></li>
          {{ end }}
        </ul>
      </nav>

      <div class="header-actions">
        <div class="lang-picker">
          {{/* INTELLIGENT LANGUAGE SWITCHER: Respects content parity globally */}}
          {{/* Determines target language and URL based on current page type and content availability */}}

          {{/* Step 1: Detect current language from URL */}}
          {{ $current_lang := $lang }}
          {{ $target_lang := cond (eq $current_lang "ro") "ru" "ro" }}
          {{ $target_url := "" }}

          {{/* Step 2: Determine target URL based on page type */}}
          {{ if eq .Section "news" }}
            {{/* NEWS ARTICLES: Check for translation using numeric prefix matching */}}
            {{/* Extract slug from URL: /ro/news/01-article-slug/ -> get "01-article-slug" */}}
            {{ $url_parts := split .RelPermalink "/" }}
            {{ $slug := index $url_parts 3 }}
            {{ $prefix_parts := split $slug "-" }}
            {{ $prefix := index $prefix_parts 0 }}

            {{/* Get all pages from target language news section */}}
            {{ $target_news_path := printf "/%s/news/" $target_lang }}
            {{ $target_section := index (where .Site.AllPages "RelPermalink" $target_news_path) 0 }}
            {{ $target_pages := cond (ne $target_section nil) ($target_section.RegularPages | default $target_section.Pages) (slice) }}

            {{/* Find matching article by numeric prefix */}}
            {{ $found := false }}
            {{ range $target_pages }}
              {{ $target_url_parts := split .RelPermalink "/" }}
              {{ $target_slug := index $target_url_parts 3 }}
              {{ $target_prefix_parts := split $target_slug "-" }}
              {{ $target_prefix := index $target_prefix_parts 0 }}
              {{ if eq $target_prefix $prefix }}
                {{ $target_url = .RelPermalink }}
                {{ $found = true }}
              {{ end }}
            {{ end }}

            {{/* Fallback to homepage if no translation found */}}
            {{ if not $found }}
              {{ $target_url = printf "/%s/" $target_lang }}
              {{ if eq $target_lang "ro" }}{{ $target_url = "/" }}{{ end }}
            {{ end }}

          {{ else if in (slice "categories" "formats" "authors" "tags" "series") .Type }}
            {{/* TAXONOMIES: Switch to same term in other language */}}
            {{ $term_slug := .Data.Term }}
            {{ $target_prefix := cond (eq $target_lang "ro") "" (printf "/%s" $target_lang) }}
            {{ $target_url = printf "%s/%s/%s/" $target_prefix .Type $term_slug }}

          {{ else if eq .Section "pages" }}
            {{/* STATIC PAGES: Switch to same page in other language */}}
            {{ $page_slug := path.Base .File.Dir }}
            {{ $target_prefix := cond (eq $target_lang "ro") "" (printf "/%s" $target_lang) }}
            {{ $target_url = printf "%s/pages/%s/" $target_prefix $page_slug }}

          {{ else }}
            {{/* FALLBACK: Homepage of target language */}}
            {{ $target_url = printf "/%s/" $target_lang }}
            {{ if eq $target_lang "ro" }}{{ $target_url = "/" }}{{ end }}
          {{ end }}

          <a href="{{ $target_url }}" class="lang-option">{{ $target_lang | upper }}</a>
        </div>
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Menu" aria-expanded="false">
          <span class="hamburger"></span>
        </button>
      </div>
    </div>
  </div>
  <div id="mobile-nav" class="mobile-nav">
    <nav>
      <ul>
        {{/* Reuse language detection from above (same workaround pattern) */}}
        {{ $url_parts := split .RelPermalink "/" }}
        {{ $lang := index $url_parts 1 }}
        {{ if not (or (eq $lang "ro") (eq $lang "ru")) }}{{ $lang = .Site.Language.Lang }}{{ end }}
        {{ $prefix := cond (eq $lang "ro") "" (printf "/%s" $lang) }}
        {{ $cats := site.Data.categories }}
        {{ range $cats }}
          {{ $title := cond (eq $lang "ru") (.ru | default .ro) .ro }}
          {{ $href := printf "%s/categories/%s/" $prefix .slug }}
          <li><a href="{{ $href }}">{{ $title }}</a></li>
        {{ end }}
      </ul>
    </nav>
  </div>
</header>
