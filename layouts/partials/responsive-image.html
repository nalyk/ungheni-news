{{/*
  Universal Responsive Image Component
  Handles raster images (JPG, PNG) with <picture> and WebP, and SVGs with a simple <img> tag.

  @param {resource} image - The Hugo image resource.
  @param {string} alt - Alt text.
  @param {string} [class] - Additional CSS classes.
  @param {string} [loading] - "lazy" or "eager". Defaults to "lazy".
  @param {string} [sizes] - The `sizes` attribute for the <img> element.
  @param {string} [priority] - "high" for LCP images.
*/}}

{{- $image := .image -}}
{{- if not $image }}{{ return }}{{ end -}}

{{- if reflect.IsString $image -}}
  {{/* Handle simple image path */}}
  <img src="{{ $image }}" alt="{{ .alt }}" class="{{ .class }}" loading="{{ .loading | default "lazy" }}">
{{- else -}}
  {{- $alt := .alt | default $image.Title -}}
  {{- $class := .class | default "" -}}
  {{- $loading := .loading | default "lazy" -}}
  {{- $priority := .priority | default "auto" -}}

  {{- if eq $image.MediaType.SubType "svg" -}}
    {{/* Handle SVG: output a simple img tag, no processing */}}
    <img src="{{ $image.RelPermalink }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         loading="{{ $loading }}"
         {{- if eq $priority "high" }} fetchpriority="high"{{ end }} />
  {{- else -}}
    {{/* Handle Raster Images: generate responsive <picture> element */}}
    {{- $sizes := .sizes | default "(max-width: 768px) 100vw, 50vw" -}}
    {{- $original_format := $image.MediaType.SubType -}}
    {{- $widths := slice 400 600 800 1200 1600 -}}

    {{- /* Generate WebP sources */ -}}
    {{- $webp_sources := slice -}}
    {{- range $widths -}}
      {{- if ge $image.Width . -}}
        {{- $resized := $image.Resize (printf "%dx webp" .) -}}
        {{- $webp_sources = $webp_sources | append (printf "%s %dw" $resized.RelPermalink .) -}}
      {{- end -}}
    {{- end -}}
    {{- $webp_srcset := delimit $webp_sources ", " -}}

    {{- /* Generate original format sources */ -}}
    {{- $original_sources := slice -}}
    {{- range $widths -}}
      {{- if ge $image.Width . -}}
        {{- $resized := $image.Resize (printf "%dx %s" . $original_format) -}}
        {{- $original_sources = $original_sources | append (printf "%s %dw" $resized.RelPermalink .) -}}
      {{- end -}}
    {{- end -}}
    {{- $original_srcset := delimit $original_sources ", " -}}

    {{- /* Select a fallback src */ -}}
    {{- $fallback_src := ($image.Resize (printf "800x %s" $original_format)).RelPermalink -}}

    <picture>
      {{- if $webp_srcset -}}
        <source type="image/webp" srcset="{{ $webp_srcset }}" sizes="{{ $sizes }}" />
      {{- end -}}
      {{- if and $original_srcset (ne $original_format "webp") -}}
        <source type="{{ $image.MediaType }}" srcset="{{ $original_srcset }}" sizes="{{ $sizes }}" />
      {{- end -}}
      
      <img src="{{ $fallback_src }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           width="{{ $image.Width }}"
           height="{{ $image.Height }}"
           loading="{{ $loading }}"
           decoding="async"
           {{- if eq $priority "high" }} fetchpriority="high"{{ end }} />
    </picture>
  {{- end -}}
{{- end -}}