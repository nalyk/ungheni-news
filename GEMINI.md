# Gemini Agent Context (`GEMINI.md`)

This document provides essential context for the Gemini CLI agent working on the `ungheni-news` project.

## 1. Project Overview

- **Project**: `ungheni-news` is a multilingual (RO/RU) news website for the city of Ungheni, Moldova.
- **Domain**: [triunghi.md](https://triunghi.md/)
- **CMS**: Decap CMS, available at [triunghi.md/admin/](https://triunghi.md/admin/)
- **Core Principle**: A static site generated by Hugo, managed via a Git-based workflow, and deployed on Cloudflare.

## 2. Core Technologies

- **Static Site Generator**: **Hugo** `v0.127.0`. See installation details in section 7.
- **Hosting**: **Cloudflare Pages**.
- **CI/CD**: Automated deployments on push to `main` via Cloudflare.
- **Scheduled Builds**: A **Cloudflare Worker** (`workers/cron.js`) triggers a new build every 5 minutes to publish scheduled posts.
- **Search**: **Pagefind** (`npx pagefind`) for client-side search.
- **CMS**: **Decap CMS** (formerly Netlify CMS) for editorial content management.
- **Authentication**: Custom OAuth2 flow for Decap CMS using a **Cloudflare Function** (`functions/api/auth.js`) to authenticate with GitHub.
- **Styling**: SCSS (`assets/css/main.scss`).
- **Package Management**: `npm` is used for `pagefind`.

## 3. Key Files & Directories

- `config/_default/config.toml`: Main Hugo configuration.
- `content/`: Location of all site content, organized by language (`ro`/`ru`).
- `layouts/`: Hugo templates. This project uses local layouts, not a theme module.
- `static/admin/`: Decap CMS configuration (`config.yml`) and entrypoint (`index.html`).
- `functions/api/auth.js`: The serverless function for GitHub OAuth with Decap CMS.
- `Makefile`: Contains all essential project commands. **Always use `make`**.
- `wrangler.toml`: Configuration for the Cloudflare Worker cron job.
- `pagefind.yml`: Configuration for the Pagefind search indexer.

## 4. Essential Commands (from `Makefile`)

- `make dev`: Starts the local Hugo development server with drafts enabled (`hugo server -D`). Access at `http://localhost:1313/`.
- `make build`: Creates a production-ready build in the `public/` directory (`HUGO_ENV=production hugo --gc --minify`).
- `make pagefind`: Indexes the content in the `public/` directory for search. **Must be run after `make build`**.
- `make check`: Runs a strict build that fails on warnings. Use for validation.
- `make validate`: Runs `scripts/validate_content.sh` to check for content errors (e.g., draft status vs. publish date).
- `make setup`: Installs Git pre-commit hooks.

**Build & Deploy Workflow**: The production deployment command is `make build && make pagefind`.

## 5. Gemini CLI Agent Workflow & Tool Usage

Your primary goal is to understand the user's request and use the available tools to fulfill it efficiently.

### 5.1. My Capabilities (MCPs)

I have access to the following toolsets (MCPs):
- `sequential-thinking`: For breaking down complex tasks.
- `hugo-mcp`: **DEPRECATED for this project, with the exception of `create_post`.** The project's `Makefile` is more reliable and specific for building and previewing the site. I will use `run_shell_command` with `make` for all Hugo-related tasks except for creating new posts.
- `playwright-extension`: For browser interaction. I have tested this tool and it appears to be functional in this environment.
- `cloudflare`: For searching Cloudflare documentation.

### 5.2. Gemini's Approach (No Sub-agents)

The previous agent (`Claude`) used a complex sub-agent system. I do not have this capability. My workflow is different:

1.  **Think Sequentially**: For any non-trivial task, I will use `sequentialthinking.sequentialthinking` to break down the problem into a clear, step-by-step plan. This is my primary method for structured problem-solving.
2.  **Execute & Verify**: I will execute the steps using the available tools (`hugo-mcp`, `run_shell_command`, `replace`, etc.).
3.  **Self-Correction**: If a step fails, I will analyze the error and revise my plan.

### 5.3. Common Task Workflows

- **Creating a new post**:
    1.  Use `hugo.create_post` to create the content file.
    2.  Use `read_file` and `replace` to add content to the new file.

- **Building the site for testing**:
    1.  Run `run_shell_command` with `command: 'make build'`.
    2.  Run `run_shell_command` with `command: 'make pagefind'`.

- **Modifying Hugo Templates (`layouts/`)**:
    1.  `read_file` to understand the relevant template.
    2.  `replace` to make the necessary changes.
    3.  `run_shell_command` with `command: 'make build'` to verify the changes don't break the build.

- **Answering questions about Cloudflare**:
    1.  Use `cloudflare.search_cloudflare_documentation` with a specific query.

## 6. Decap CMS GitHub OAuth Flow

This is a critical and complex part of the project. Refer to this summary if you need to debug or modify it.

- **Trigger**: User clicks "Login with GitHub" in `/admin/`.
- **Endpoint**: The CMS opens a popup to `/api/auth`, which is handled by the Cloudflare Function in `functions/api/auth.js`.
- **Process**:
    1.  The function redirects to the GitHub OAuth screen.
    2.  After user approval, GitHub redirects back to `/api/auth` with a temporary `code`.
    3.  The function exchanges the `code` for an access `token` with the GitHub API.
    4.  **Crucially**, the function returns a small HTML page that uses `postMessage` to send the token back to the CMS window.
- **`postMessage` Format**: The message must be a **string** in the format `'authorization:github:success:{"token":"...","provider":"github"}'`. A two-step handshake (`"authorizing:github"` then the success message) is required.
- **Key Files**:
    - `functions/api/auth.js`: The logic for the entire flow.
    - `static/admin/config.yml`: Defines the `auth_endpoint`.
    - `static/admin/index.html`: Contains debugging listeners for `postMessage`.

## 7. Final Instructions

- **Prioritize `make`**: Always use the `Makefile` commands. Do not run `hugo` directly unless necessary.
- **Hugo Installation**: The required Hugo version `v0.127.0` is installed at `~/bin/hugo`.
- **Acknowledge Limitations**: I do not have sub-agents. I will use sequential thinking to manage complexity.
- **Playwright is Functional**: The `playwright-extension` has been tested and is functional in this environment.

## 8. UI/UX Development and Verification Protocol

This protocol is my standard procedure for implementing and verifying any changes that affect the website's layout, UI, or UX.

1.  **Code Implementation:** I will make the required changes to the relevant HTML, CSS, and/or JavaScript files.
2.  **Deployment:** I will commit and push the changes to the `main` branch, which will trigger a Cloudflare Pages deployment.
3.  **Wait for Deployment:** I will use the `browser_wait_for` tool to pause for a reasonable amount of time (e.g., 2-3 minutes) to allow the deployment to complete.
4.  **Verification:** This is the most critical step. I will perform a series of checks to verify the deployment and the changes.
    *   **Structural Verification:** I will navigate to the affected page and use `browser_snapshot` to get the new accessibility tree. I will analyze this snapshot to confirm that the HTML structure has changed as expected.
    *   **Visual Verification:** I will use `browser_take_screenshot` to capture a visual representation of the changes. I will then present the path to this screenshot to you for visual feedback. This is how I will "see" the result through your eyes.
    *   **Screenshot Storage:** All screenshots will be saved in the `dev_screens/` directory within the project repository. This directory is included in `.gitignore` to prevent committing images to the repository.
    *   **Responsive Design Verification:** For any significant layout changes, I will use `browser_resize` to test the page at different viewport sizes (e.g., 375px for mobile, 768px for tablet, 1440px for desktop). I will take screenshots at each size to verify the responsiveness.
    *   **Asset Loading Verification:** I will use `browser_network_requests` to check for any 404 errors, ensuring that all new assets (images, CSS, JS) are loading correctly. This would have caught the issue with the image in our previous interaction.
    *   **Interaction Verification:** For changes involving interactive elements (buttons, forms, etc.), I will use tools like `browser_click`, `browser_hover`, and `browser_type` to test their functionality.
5.  **Analysis and Decision:** Based on the results of the verification steps, I will determine if the change was successful.
    *   If successful, I will report my findings and the successful verification to you.
    *   If unsuccessful, I will analyze the errors (e.g., 404s in network requests, incorrect structure in the snapshot) and formulate a plan to fix the issue.
6.  **Report and Handoff:** I will present a summary of my actions, the verification results (including screenshot paths), and my conclusion to you for final approval or further feedback.